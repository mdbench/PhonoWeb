<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhonoWeb</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: #121212;
            color: #e0e0e0;
        }
        header {
            height: fit-content;
            padding: 10px;
            max-width: 1000px;
            margin: 0 auto;
        }
        .logo {
            display: flex;
            flex-flow: row;
            justify-content: start;
            align-items: center;
        }
        .logo img {
            width: auto;
            height: 40px;
            border-radius: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .player-section {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .file-list {
            background: #1e1e1e;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .file-item {
            padding: 10px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .file-item:hover {
            background: #2a2a2a;
        }
        .folder-path {
            color: #7f7f7f;
            font-size: 0.9em;
        }
        .file-name {
            font-weight: 500;
        }
        .duration {
            color: #9e9e9e;
        }
        button {
            background: #6200ee;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }
        button:hover {
            background: #7c4dff;
        }
        .current-track {
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 500;
        }
        .waveform {
            height: 100px;
            background: #333;
            border-radius: 5px;
            margin: 15px 0;
            position: relative;
            overflow: hidden;
        }
        .waveform-bar {
            position: absolute;
            bottom: 0;
            width: 2px;
            background: #6200ee;
            margin-right: 1px;
        }
        .player-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #progressBarContainer {
            flex-grow: 1;
        }
        #progressBar {
            width: 100%;
            cursor: pointer;
            accent-color: #6200ee;
        }
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        input[type="file"] {
            display: none;
        }
        .add-folder-btn {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <img src="PhonoWeb.jpg" alt="PhonoWeb Logo">
            <h1>PhonoWeb</h1>
        </div>
    </header>
    <div class="container">
        <button class="add-folder-btn" id="addFolderBtn">Add Music Folder</button>
        <input type="file" id="folderInput" webkitdirectory directory multiple />

        <div class="player-section">
            <div class="current-track" id="currentTrack">No track selected</div>
            <div class="waveform" id="waveform"></div>
            <div class="controls">
                <button id="playBtn">Play</button>
                <button id="pauseBtn" disabled>Pause</button>
                <div id="progressBarContainer">
                    <input type="range" id="progressBar" min="0" max="100" value="0">
                </div>
                <span id="currentTimeDisplay">0:00</span> / <span id="durationDisplay">0:00</span>
            </div>
        </div>

        <div class="file-list" id="fileList">
            <div>Loading files...</div>
        </div>
    </div>

    <script>
        // Database variables
        const DB_NAME = 'AudioFolderIndexer';
        const FOLDER_STORE = 'folders';
        const FILE_STORE = 'files';
        
        // Global variables
        let db;
        let audioContext;
        let analyser;
        let audio = new Audio();
        let currentFileHandle;
        let animationId;

        // DOM variables
        const progressBar = document.getElementById("progressBar");
        const currentTimeDisplay = document.getElementById("currentTimeDisplay");
        const durationDisplay = document.getElementById("durationDisplay");
        
        // Initialize IndexedDB
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 2);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains(FOLDER_STORE)) {
                        db.createObjectStore(FOLDER_STORE, { keyPath: 'path' });
                    }
                    
                    if (!db.objectStoreNames.contains(FILE_STORE)) {
                        db.createObjectStore(FILE_STORE, { keyPath: 'fullPath' });
                    }
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                
                request.onerror = (event) => {
                    reject('Error opening database');
                };
            });
        }
        
        // Add folder to database
        async function addFolder(folderHandle) {
            const tx = db.transaction(FOLDER_STORE, 'readwrite');
            const store = tx.objectStore(FOLDER_STORE);
            
            await store.put({
                path: folderHandle.name,
                handle: folderHandle
            });
            
            await scanFolder(folderHandle);
        }
        
        // Scan folder for audio files
        async function scanFolder(folderHandle) {
            const entries = await folderHandle.entries();
            const audioFiles = [];
            
            for await (const entry of entries) {
                const [name, handle] = entry;
                
                if (handle.kind === 'file' && isAudioFile(name)) {
                    const duration = await getAudioDuration(handle);
                    const fullPath = `${folderHandle.name}/${name}`;
                    
                    const tx = db.transaction(FILE_STORE, 'readwrite');
                    const store = tx.objectStore(FILE_STORE);
                    
                    await store.put({
                        fullPath: fullPath,
                        name: name,
                        duration: duration,
                        folder: folderHandle.name,
                        handle: handle
                    });
                }
                else if (handle.kind === 'directory') {
                    await scanFolder(handle);
                }
            }
        }
        
        // Check if file is audio
        function isAudioFile(filename) {
            const audioExtensions = ['.mp3', '.wav', '.ogg', '.aac', '.flac', '.m4a'];
            return audioExtensions.some(ext => filename.toLowerCase().endsWith(ext));
        }
        
        // Get audio duration
        async function getAudioDuration(fileHandle) {
            await verifyPermission(fileHandle);
            const file = await fileHandle.getFile();
            const url = URL.createObjectURL(file);
            
            return new Promise((resolve) => {
                const audio = new Audio();
                audio.src = url;
                
                audio.onloadedmetadata = () => {
                    resolve(Math.floor(audio.duration));
                    URL.revokeObjectURL(url);
                };
                
                audio.onerror = () => {
                    resolve(0);
                    URL.revokeObjectURL(url);
                };
            });
        }
        
        // Convert seconds to MM:SS format
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }
        // Helper function to format time (seconds to mm:ss)
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60).toFixed(0);
            const secs = Math.floor(seconds % 60).toFixed(0);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }
        
        // Render file list
        async function renderFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            const tx = db.transaction(FILE_STORE, 'readonly');
            const store = tx.objectStore(FILE_STORE);
            const cursorRequest = store.openCursor();
            
            cursorRequest.onsuccess = (event) => {
                const cursor = event.target.result;
                
                if (cursor) {
                    const file = cursor.value;
                    
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.onclick = () => playFile(file.handle, file.fullPath);
                    
                    const fileInfo = document.createElement('div');
                    
                    const fileName = document.createElement('div');
                    fileName.className = 'file-name';
                    fileName.textContent = file.name;
                    
                    const folderPath = document.createElement('div');
                    folderPath.className = 'folder-path';
                    folderPath.textContent = file.folder;
                    
                    fileInfo.appendChild(fileName);
                    fileInfo.appendChild(folderPath);
                    
                    const duration = document.createElement('div');
                    duration.className = 'duration';
                    duration.textContent = formatDuration(file.duration);
                    
                    fileItem.appendChild(fileInfo);
                    fileItem.appendChild(duration);
                    
                    fileList.appendChild(fileItem);
                    
                    cursor.continue();
                }
            };
        }
        
        // Play audio file
        async function playFile(fileHandle, fullPath) {
            if (currentFileHandle === fileHandle && !audio.paused) return;
            
            await verifyPermission(fileHandle);
            
            document.getElementById('playBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('currentTrack').textContent = fullPath;
            
            const file = await fileHandle.getFile();
            const url = URL.createObjectURL(file);
            
            audio.src = url;
            audio.load();
            
            await audio.play();
            currentFileHandle = fileHandle;
            
            setupAudioVisualizer();
        }
        
        // Ask for permission on restarted sessions
        async function verifyPermission(fileHandle, readWrite = false) {
            const options = { mode: readWrite ? 'readwrite' : 'read' };
            if ((await fileHandle.queryPermission(options)) === 'granted') {
                return true;
            }
            if ((await fileHandle.requestPermission(options)) === 'granted') {
                return true;
            }
            return false;
        }

        // Setup progressors
        audio.addEventListener('loadedmetadata', () => {
            // Update the duration once metadata is loaded
            const audioDurationFixed = audio.duration.toFixed(0);
            progressBar.max = audioDurationFixed;
            durationDisplay.textContent = formatTime(audioDurationFixed);
        });

        audio.addEventListener('timeupdate', () => {
            // Sync the progress bar and current time display with audio playback
            const audioCurrentFixed = audio.currentTime.toFixed(0);
            progressBar.value = audioCurrentFixed;
            currentTimeDisplay.textContent = formatTime(audioCurrentFixed);
        });

        progressBar.addEventListener('input', () => {
            // Enable seeking when the user interacts with the progress bar
            audio.currentTime = progressBar.value;
        });
        
        // Setup audio visualizer
        function setupAudioVisualizer() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                
                const source = audioContext.createMediaElementSource(audio);
                source.connect(analyser);
                analyser.connect(audioContext.destination);
            }
            
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            
            drawVisualizer();
        }
        
        // Draw audio visualizer
        function drawVisualizer() {
            const waveform = document.getElementById('waveform');
            waveform.innerHTML = '';
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);
            
            const barWidth = waveform.offsetWidth / bufferLength;
            
            for (let i = 0; i < bufferLength; i++) {
                const barHeight = (dataArray[i] / 255) * waveform.offsetHeight;
                
                const bar = document.createElement('div');
                bar.className = 'waveform-bar';
                bar.style.height = `${barHeight}px`;
                bar.style.left = `${i * barWidth}px`;
                bar.style.width = `${barWidth}px`;
                
                waveform.appendChild(bar);
            }
            
            animationId = requestAnimationFrame(drawVisualizer);
        }
        
        // Initialize the app
        async function init() {
            await initDB();
            
            document.getElementById('addFolderBtn').addEventListener('click', async () => {
                try {
                    const dirHandle = await window.showDirectoryPicker();
                    await addFolder(dirHandle);
                    await renderFileList();
                } catch (err) {
                    console.error('Error accessing folder:', err);
                }
            });
            
            document.getElementById('playBtn').addEventListener('click', () => {
                if (audio.paused && currentFileHandle) {
                    audio.play();
                    document.getElementById('playBtn').disabled = true;
                    document.getElementById('pauseBtn').disabled = false;
                    setupAudioVisualizer();
                }
            });
            
            document.getElementById('pauseBtn').addEventListener('click', () => {
                if (!audio.paused) {
                    audio.pause();
                    document.getElementById('playBtn').disabled = false;
                    document.getElementById('pauseBtn').disabled = true;
                    
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                        animationId = null;
                    }
                }
            });
            
            audio.addEventListener('ended', () => {
                document.getElementById('playBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = true;
                
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
            });
            
            await renderFileList();
        }
        
        init();
    </script>
</body>
</html>
